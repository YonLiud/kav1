name: Build Installer

on:
  push:
    branches: [main, dev]
  workflow_run:
    workflows: ["Lint & Check"]
    types: [completed]

jobs:
  build:
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - run: |
        $sha = git rev-parse --short HEAD
        echo "SHORT_SHA=$sha" >> $env:GITHUB_ENV
        echo $sha > frontend/version.txt
        echo $sha > backend/version.txt
        echo "RELEASE_BUILD=true" >> $env:GITHUB_ENV

    - run: |
        if ("$env:GITHUB_REF_NAME" -eq "main") {
          echo "BRANCH_SUFFIX=_main" >> $env:GITHUB_ENV
          echo "IS_PRERELEASE=false" >> $env:GITHUB_ENV
        } else {
          echo "BRANCH_SUFFIX=_dev" >> $env:GITHUB_ENV
          echo "IS_PRERELEASE=true" >> $env:GITHUB_ENV
        }

    - run: |
        pip install -r requirements.txt
        pip install pyinstaller

    - run: .\build_windows.bat

    - run: choco install innosetup -y

    - run: |
        mkdir C:\installer_output
        & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" /Qp /O"C:\installer_output" /F"kav1_setup_${{ env.SHORT_SHA }}" kav1.iss

    - uses: actions/upload-artifact@v4
      with:
        name: installer
        path: C:/installer_output/kav1_setup_${{ env.SHORT_SHA }}.exe
